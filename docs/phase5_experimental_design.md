# Phase 5: Experimental Design

## Randomized Crossover Intervention Study for Heating Strategy Optimization

---

## 1. Study Overview

### 1.1 Objective
Evaluate three heating control strategies in a real-world setting to determine which optimizes the trade-off between comfort, energy efficiency, and cost.

### 1.2 Study Design
| Aspect | Value |
|--------|-------|
| **Type** | Randomized crossover intervention study |
| **Duration** | 20 weeks (November 2027 - March 2028) |
| **Block length** | 7 days per condition (weekly) |
| **Washout period** | 3 days (excluded from analysis) |
| **Measurement period** | 4 days (used for analysis) |
| **Conditions** | 3 strategies |
| **Total blocks** | 20 blocks (~6-7 per strategy) |
| **Statistical power** | 97% to detect +0.30 COP change |
| **Randomization** | Latin square with weather stratification |

### 1.3 Data-Driven Parameter Estimates

These parameters were estimated from 69 days of historical data using `src/phase5/estimate_study_parameters.py`:

| Parameter | Value | Basis |
|-----------|-------|-------|
| **Heating response time (τ_effort)** | 12.4 hours | Weighted average from transfer function model |
| **Washout period** | 3 days (72 hours) | 3×τ_effort = 37h, rounded up for weekly blocks |
| **COP residual std** | 0.21 | After HDD adjustment (R²=0.93) |
| **Minimum detectable effect** | +0.30 COP | 97% power with 7-day blocks |

**Note on τ_effort:** The Phase 3 thermal model uses a transfer function approach with separate time constants for outdoor temperature response (τ_outdoor: 24-120h) and heating effort response (τ_effort: 8-48h). For washout calculation, we use τ_effort because it represents how quickly indoor temperature equilibrates after changing heating parameters.

### 1.4 Primary Research Questions
1. Which strategy achieves the best COP while maintaining comfort?
2. How much grid consumption can be reduced by shifting heating to solar hours?
3. What is the cost savings potential of tariff-aware scheduling?
4. Are there strategy × weather interactions that inform adaptive control?

---

## 2. Controllable Parameters

### 2.1 Parameter Summary

| Parameter | Symbol | Range | How to Change |
|-----------|--------|-------|---------------|
| Comfort start time | `t_comfort_start` | 06:00 - 12:00 | Heat pump scheduler |
| Comfort end time | `t_comfort_end` | 16:00 - 22:00 | Heat pump scheduler |
| Setpoint (comfort) | `T_setpoint_comfort` | 19 - 22°C | Home Assistant climate entity |
| Setpoint (eco) | `T_setpoint_eco` | **12 - 19°C** | Home Assistant climate entity |
| Curve rise (Steilheit) | `curve_rise` | 0.80 - 1.20 | Heat pump interface menu |

**Note on Eco Setpoint Range:** Phase 2 multivariate analysis revealed that eco setpoint has minimal effect on daytime comfort (-0.09°C per 1°C change). This allows aggressive eco setbacks down to 12°C (frost protection level) without compromising comfort during occupied hours (08:00-22:00).

### 2.2 Parameter Change Locations

#### Heat Pump Interface (Stiebel Eltron ISG)
- **Schedule timing**: Menu → Time Programs → Heating → Set comfort period start/end
- **Curve rise**: Menu → Heating → Heating Curve → Steilheit (slope)

#### Home Assistant
- **Setpoints**: Climate entity → Set target temperature
  - Comfort mode: Set during comfort hours
  - Eco mode: Set during eco hours
- **Automation**: Optional scripts for scheduled setpoint changes

### 2.3 Derived Parameters

The heating curve model determines flow temperature:
```
T_flow = T_setpoint + curve_rise × (T_ref - T_outdoor)
```

Where:
- `T_ref` = 21.32°C (comfort mode) or 19.18°C (eco mode)
- Lower `curve_rise` → lower flow temp → higher COP (~+0.10 COP per 1°C reduction)

---

## 3. Strategy Definitions

**Strategy Selection Method:** Strategies B and C were selected from 21 Pareto-optimal solutions
generated by NSGA-II multi-objective optimization (`src/phase4/04_pareto_optimization.py`).
The optimizer explored 5 decision variables across 4 objectives (comfort, grid, cost, min temp).

Key insight from Pareto optimization: All optimal strategies converge to:
- Short comfort window (~4h) aligned with solar peak (11:00-16:00)
- Aggressive eco setback (12-14°C) - minimal effect on daytime comfort
- High comfort setpoint (22°C) during the short comfort window

---

### 3.1 Strategy A: Baseline (Control)
Current system settings serving as reference.

| Parameter | Value | Notes |
|-----------|-------|-------|
| Comfort start | **06:30** | Early morning pre-heat |
| Comfort end | **20:00** | Evening cooldown |
| Setpoint comfort | **20.2°C** | Current winter setting |
| Setpoint eco | **18.5°C** | Night/away setting |
| Curve rise | **1.08** | Factory default |

**Expected outcomes**: Grid ~1200 kWh, Cost ~320 CHF (64-day simulation period)

---

### 3.2 Strategy B: Grid-Minimal (Pareto-Optimized)
Minimize grid electricity import. Selected from Pareto front (Jan 2026 optimization, 5% constraint).

| Parameter | Value | Notes |
|-----------|-------|-------|
| Comfort start | **09:00** | Aligned with solar peak |
| Comfort end | **16:00** | 7h comfort window |
| Setpoint comfort | **22.0°C** | Higher comfort during short window |
| Setpoint eco | **12.0°C** | Aggressive setback (Pareto-optimal) |
| Curve rise | **0.89** | Balanced for comfort constraint |

**Expected outcomes**: Grid 2235 kWh, Cost 704 CHF, Violation 4.5%, Min temp 17.3°C (52-day simulation)

**Rationale:** Lowest grid import on Pareto front while meeting 5% violation constraint.
The aggressive eco setback (12.0°C) has minimal effect on daytime comfort. Higher curve_rise
(0.89 vs 0.83) ensures adequate heating during cold periods.

---

### 3.3 Strategy C: Balanced (Pareto-Optimized)
Balance comfort and energy efficiency. Selected from Pareto front (Jan 2026 optimization, 5% constraint).

| Parameter | Value | Notes |
|-----------|-------|-------|
| Comfort start | **10:00** | Aligned with solar peak |
| Comfort end | **16:00** | 6h comfort window |
| Setpoint comfort | **21.9°C** | Higher comfort during short window |
| Setpoint eco | **12.1°C** | Aggressive setback (Pareto-optimal) |
| Curve rise | **0.90** | Balanced for comfort constraint |

**Expected outcomes**: Grid 2239 kWh, Cost 703 CHF, Violation 4.7%, Min temp 17.3°C (52-day simulation)

**Rationale:** Best trade-off between grid and cost while meeting 5% violation constraint.
Similar parameters to Grid-Minimal with slightly later start for marginally lower cost.

---

## 4. Randomization Schedule

### 4.1 Design Principles
- **Latin square**: Each strategy appears once in each season tercile
- **Weather stratification**: Balance cold/mild periods across strategies
- **Carryover balance**: No strategy follows itself

### 4.2 Schedule Generation
Run the schedule generator before study start:
```bash
python src/phase5/generate_schedule.py --start 2027-11-01 --weeks 20 --seed 42
```

Output: `output/phase5/block_schedule.csv`

### 4.3 Example Schedule Structure

| Block | Start Date | End Date | Strategy | Season | Washout | Measurement |
|-------|------------|----------|----------|--------|---------|-------------|
| 1 | 2027-11-01 | 2027-11-07 | C | Early | Nov 1-3 | Nov 4-7 |
| 2 | 2027-11-08 | 2027-11-14 | B | Early | Nov 8-10 | Nov 11-14 |
| 3 | 2027-11-15 | 2027-11-21 | A | Early | Nov 15-17 | Nov 18-21 |
| 4 | 2027-11-22 | 2027-11-28 | C | Early | Nov 22-24 | Nov 25-28 |
| ... | ... | ... | ... | ... | ... | ... |

### 4.4 Season Definitions
- **Early winter**: Nov 1 - Dec 15 (blocks 1-6)
- **Mid winter**: Dec 16 - Feb 15 (blocks 7-14)
- **Late winter**: Feb 16 - Mar 21 (blocks 15-20)

---

## 5. Block Transition Protocol

### 5.1 Transition Timing
- **Change time**: 00:00 (midnight) on block day 1 (weekly, e.g., every Monday)
- **Washout period**: Days 1-3 (72 hours, excluded from analysis)
- **Measurement period**: Days 4-7 (96 hours, used for analysis)
- **Block ends**: 23:59 on day 7

The 3-day washout is based on the building's thermal time constant (τ_effort = 12.4 hours). After 3×τ (~37 hours), the system reaches 95% of the new equilibrium. The extra day provides margin for scheduling.

### 5.2 Step-by-Step Parameter Change Procedure

#### Before Transition (Evening Before)
1. [ ] Verify current block data is complete
2. [ ] Review next block's strategy parameters
3. [ ] Prepare any manual changes needed

#### At Transition Time (00:00)
1. [ ] **Heat pump scheduler**: Set new comfort start/end times
2. [ ] **Curve rise**: Navigate to Heating Curve menu, adjust Steilheit
3. [ ] **Home Assistant**: Update climate entity setpoints
4. [ ] **Log**: Record exact change time in block log

#### Verification (Morning After)
1. [ ] Confirm schedule is active (check heat pump display)
2. [ ] Verify setpoints responded correctly
3. [ ] Check sensor data logging is operational

### 5.3 Parameter Change Quick Reference

```
STRATEGY A (Baseline):
  Schedule: 06:30 - 20:00
  Setpoints: Comfort 20.2°C, Eco 18.5°C
  Curve rise: 1.08

STRATEGY B (Grid-Minimal, Pareto-Optimized, 5% constraint):
  Schedule: 09:00 - 16:00
  Setpoints: Comfort 22.0°C, Eco 12.0°C
  Curve rise: 0.89

STRATEGY C (Balanced, Pareto-Optimized, 5% constraint):
  Schedule: 10:00 - 16:00
  Setpoints: Comfort 21.9°C, Eco 12.1°C
  Curve rise: 0.90
```

**Note:** Strategies B and C use aggressive eco setpoints (~12°C). Phase 2 analysis confirmed
this has minimal effect on daytime comfort (-0.09°C per 1°C change). The higher curve_rise
(0.89-0.90) compared to earlier optimizations (0.83) ensures the 5% violation constraint is met.

---

## 6. Daily Monitoring

### 6.1 Daily Checklist

Complete each day during the study:

- [ ] **Comfort check**: Verify T_weighted ≥ 18.5°C for ≥95% of 08:00-22:00
- [ ] **Sensor quality**: Confirm all sensors reporting (no gaps)
- [ ] **Manual overrides**: Log any user interventions with reason
- [ ] **Occupancy notes**: Record deviations from normal patterns
- [ ] **Weather log**: Note significant weather events

### 6.2 Alert Thresholds

| Condition | Threshold | Action |
|-----------|-----------|--------|
| Room temp too low | T_weighted < 16°C | Abort strategy, return to Baseline |
| Flow temp too high | T_flow > 45°C | Check curve settings |
| High violation % | > 30% for 24h | Review and document |
| Sensor dropout | > 2h gap | Log and verify data |

### 6.3 Daily Data Log Template

```
Date: ________
Block: ___ of 20
Strategy: [ ] A  [ ] B  [ ] C

Weather:
  - Outdoor temp (min/max): ___°C / ___°C
  - HDD (base 18°C): ___
  - Cloud cover: [ ] Clear  [ ] Partial  [ ] Overcast

Comfort metrics (08:00-22:00):
  - Avg temp: ___°C
  - Min temp: ___°C at ___:___
  - Violation %: ___% (target: ≤5%)

Energy:
  - Grid import: ___ kWh
  - PV generation: ___ kWh
  - Heat produced: ___ kWh
  - COP (if calculable): ___

Overrides/Notes:
_________________________________
_________________________________
```

---

## 7. Block Summary Log

Complete at end of each 7-day block:

### 7.1 Block Summary Template

```
BLOCK SUMMARY

Block number: ___
Strategy: ___
Dates: ___________ to ___________

Weather summary:
  - Mean outdoor temp: ___°C
  - Total HDD: ___
  - PV generation days: ___ good / ___ partial / ___ poor

Performance metrics:
  - Avg daytime temp: ___°C
  - Violation %: ___% (target: ≤5%)
  - Grid consumption: ___ kWh
  - Grid per HDD: ___ kWh/HDD
  - Mean COP: ___
  - Net cost: CHF ___

Issues/Observations:
_________________________________
_________________________________

Manual overrides: [ ] None  [ ] See notes

Block quality: [ ] Good  [ ] Usable  [ ] Exclude (reason: ___)
```

---

## 8. Outcome Measures

### 8.1 Primary Outcomes

| Outcome | Definition | Unit | Target |
|---------|------------|------|--------|
| **Average Temperature** | Mean T_weighted during 08:00-22:00 | °C | Maximize |
| **Violation %** | % time T_weighted < 18.5°C during 08:00-22:00 | % | ≤5% (constraint) |
| **Grid per HDD** | External supply ÷ Heating degree days | kWh/HDD | Minimize |
| **COP** | Heat produced ÷ Electricity consumed | - | Maximize |
| **Net cost per HDD** | (Import×rate - Export×feedin) ÷ HDD | CHF/HDD | Minimize |

### 8.2 Secondary Outcomes

| Outcome | Definition | Unit |
|---------|------------|------|
| Solar utilization | % heating during solar hours | % |
| Battery contribution | Battery discharge for heating | kWh |
| Peak flow temperature | Max T_flow observed | °C |
| Compressor cycles | Number of on/off cycles | count |

### 8.3 Comfort Constraint

**Constraint Definition:**
- T_weighted must not be below 18.5°C for more than **5%** of daytime hours (08:00-22:00)
- There is **no upper temperature limit** - higher temperatures are always acceptable
- This constraint applies equally to all strategies

| Strategy | Min Threshold | Max Threshold | Evaluation Hours |
|----------|---------------|---------------|------------------|
| All strategies | 18.5°C | None | 08:00-22:00 |

**Rationale:** The optimization framework uses three objectives (maximize average temperature, minimize grid import, minimize net cost) with a soft constraint on low-temperature violations. The 5% limit was tightened from 20% after evaluation showed energy-optimized strategies had 15-19% violation and minimum temperatures of 16.7°C with the looser constraint.

**Note:** All comfort metrics are evaluated using T_weighted (see Section 8.4).

### 8.4 Weighted Indoor Temperature Definition

The comfort objective uses weighted indoor temperature:

```
T_weighted = Σ(weight_i × T_sensor_i)
```

**Available sensors:** davis_inside, office1, atelier, studio, simlab

In principle, multiple room sensors can be weighted (configured via `SENSOR_WEIGHTS` dict
in the code). In practice, only `davis_inside_temperature` is used (100% weight):

| Sensor | Weight | Rationale |
|--------|--------|-----------|
| `davis_inside_temperature` | 100% | Primary living area, central location, least noise |
| `office1_temperature` | 0% | Excluded due to measurement noise |
| `atelier_temperature` | 0% | Excluded due to measurement noise |
| `studio_temperature` | 0% | Excluded due to measurement noise |
| `simlab_temperature` | 0% | Excluded due to measurement noise |

**Rationale for single sensor:**
- Other room sensors have excessive measurement noise that degrades model performance
- Single-sensor model achieves R²=0.683 vs R²=0.569 with 5-sensor weighted average
- davis_inside has lowest measurement noise and central location
- Simplest model with fewest parameters

**Multi-sensor support:** The code supports weighted averaging via `SENSOR_WEIGHTS` dict
in `src/phase3/01_thermal_model.py` and related files. If sensor quality improves or
additional sensors are added, weights can be adjusted without code changes.

---

## 9. Safety Protocol

### 9.1 Hard Limits (Automatic Abort)

| Parameter | Limit | Action |
|-----------|-------|--------|
| Min room temperature | < 16°C | Revert to Baseline immediately |
| Max flow temperature | > 48°C | Check heat pump, reduce curve_rise |
| Heat pump error | Any fault code | Pause study, resolve issue |

### 9.2 Soft Limits (Review Required)

| Parameter | Limit | Action |
|-----------|-------|--------|
| Violation % > 30% | For 24 hours | Document, consider adjustment |
| COP < 3.0 | Single day | Check conditions, verify data |
| Manual override | Any | Document reason, include in analysis |

### 9.3 Study Pause Criteria
- Equipment malfunction requiring repair
- Extended absence (> 7 days)
- Unusual weather event (e.g., power outage)
- Request from household member

---

## 10. Statistical Analysis Plan

### 10.1 Primary Analysis

Mixed-effects linear regression:
```
Y ~ Strategy + HDD + Solar_hours + Season + (1|Block)
```

Where:
- `Y` = outcome (grid_per_HDD, COP, cost_per_HDD)
- `Strategy` = factor (A, B, C, D)
- `HDD` = heating degree days (covariate)
- `Solar_hours` = daily solar availability (covariate)
- `Season` = early/mid/late winter (factor)
- `(1|Block)` = random block effect

### 10.2 Pairwise Comparisons

- Compare each optimized strategy vs Baseline
- Tukey HSD adjustment for multiple comparisons
- Report effect size with 95% CI

### 10.3 Subgroup Analyses

- Strategy × Weather interaction (cold vs mild days)
- Strategy × Season interaction
- Weekday vs weekend effects

### 10.4 Sample Size Justification

Based on power analysis using historical data (`src/phase5/estimate_study_parameters.py`):

| Metric | Value |
|--------|-------|
| COP residual std (after HDD adjustment) | 0.21 |
| Minimum detectable effect | +0.30 COP |
| Expected effect (Energy-Optimized) | +0.30 COP |
| Blocks per strategy | 6-7 |
| Measurement days per block | 4 |
| Statistical power | 97% |
| α | 0.05 (two-sided) |

**Key insight**: 7-day blocks improve power from ~75% (4-day) to ~97% (7-day) because more measurement days per block reduces within-block variance. HDD explains 92.5% of COP variance, further enabling detection of smaller effects.

---

## 11. Data Management

### 11.1 Automated Data Collection

Continuous logging via Home Assistant / InfluxDB:
- All temperature sensors (15-min intervals)
- Energy meters (15-min intervals)
- Heat pump status (1-min intervals)
- Weather station (5-min intervals)

### 11.2 Manual Data Collection

- Daily checklist (see Section 6)
- Block summary (see Section 7)
- Override log with timestamps

### 11.3 Data Quality Checks

Run weekly:
```bash
python src/phase5/data_quality_check.py --week N
```

Checks:
- Sensor gaps > 1 hour
- Outlier values (|z| > 4)
- Missing block logs

### 11.4 Data Storage

```
output/phase5/
├── block_schedule.csv          # Pre-generated schedule
├── daily_logs/                 # Daily checklist entries
│   ├── 2027-11-01.json
│   └── ...
├── block_summaries/            # Block summary entries
│   ├── block_01.json
│   └── ...
├── sensor_data/                # Extracted sensor data per block
│   ├── block_01_sensors.parquet
│   └── ...
└── analysis/                   # Statistical outputs
    ├── primary_results.csv
    └── figures/
```

---

## 12. Timeline

### 12.1 Pre-Study (October 2027)

- [ ] Week -4: Verify all sensors operational
- [ ] Week -3: Test parameter change procedures
- [ ] Week -2: Generate randomization schedule
- [ ] Week -1: Backup current settings, prepare logs

### 12.2 Study Period (November 2027 - March 2028)

| Phase | Dates | Blocks | Focus |
|-------|-------|--------|-------|
| Early winter | Nov 1 - Dec 15 | 1-6 | Initial data, refine washout |
| Mid winter | Dec 16 - Feb 15 | 7-14 | Core data collection |
| Late winter | Feb 16 - Mar 21 | 15-20 | Final blocks, wrap-up |

### 12.3 Post-Study (April 2028)

- [ ] Week +1: Final data extraction
- [ ] Week +2-3: Statistical analysis
- [ ] Week +4: Report and recommendations

---

## 13. Appendices

### Appendix A: Heating Curve Reference

The heat pump uses a heating curve to determine flow temperature based on outdoor temperature:

```
T_flow = T_setpoint + curve_rise × (T_ref - T_outdoor)
```

Where T_ref = 21.32°C (comfort mode) or 19.18°C (eco mode).

Example calculations during **comfort mode** (T_outdoor = 0°C):

| Strategy | Setpoint | Curve Rise | T_ref | T_flow |
|----------|----------|------------|-------|--------|
| Baseline | 20.2°C | 1.08 | 21.3°C | 43.2°C |
| Grid-Minimal | 22.0°C | 0.89 | 21.3°C | 41.0°C |
| Balanced | 21.9°C | 0.90 | 21.3°C | 41.1°C |

Example calculations during **eco mode** (T_outdoor = 0°C):

| Strategy | Setpoint | Curve Rise | T_ref | T_flow |
|----------|----------|------------|-------|--------|
| Baseline | 18.5°C | 1.08 | 19.2°C | 39.2°C |
| Grid-Minimal | 12.0°C | 0.89 | 19.2°C | 29.1°C |
| Balanced | 12.1°C | 0.90 | 19.2°C | 29.4°C |

**Note:** The Pareto-optimized strategies (B, C) use much lower eco flow temperatures
(~29°C vs 39°C baseline), significantly reducing heat pump energy consumption
during non-solar hours. The higher curve_rise (0.89-0.90 vs earlier 0.83) ensures
adequate comfort during cold periods while meeting the 5% violation constraint.

### Appendix B: Tariff Schedule Reference

| Period | Hours | Rate Type | Purchase (Rp/kWh) |
|--------|-------|-----------|-------------------|
| Mon-Fri | 06:00-21:00 | High | 35.9 |
| Mon-Fri | 21:00-06:00 | Low | 27.7 |
| Saturday | 06:00-12:00 | High | 35.9 |
| Saturday | 12:00-24:00 | Low | 27.7 |
| Sunday | All day | Low | 27.7 |
| Holidays | All day | Low | 27.7 |

### Appendix C: Sensor List

Primary sensors for analysis:
- `davis_inside_temperature` - Indoor reference (100% - single sensor)
- `davis_outside_temperature` - Outdoor reference
- `wp_hk2_ist` - Flow temperature (HK2)
- `energy_produced_heating` - Heat output
- `energy_consumed_heating` - Electricity input

### Appendix D: Emergency Procedures

**If room temperature drops below 16°C:**
1. Immediately switch to Strategy A (Baseline)
2. If still declining after 2 hours, increase setpoint to 22°C
3. Document incident in block log
4. Review cause before resuming test strategy

**If heat pump shows error:**
1. Note error code and timestamp
2. Attempt reset per manufacturer instructions
3. If unresolved, pause study and call service
4. Resume from Baseline when repaired

---

## Appendix E: Pilot Experiment (January-March 2026)

### E.1 Purpose

Before the main Phase 5 intervention study, a pilot experiment explores the parameter space to learn the **thermal response function**:

```
T_indoor = f(T_HK2 history, T_outdoor history, thermal_mass)
```

**Key Insight:** The heating curve model is deterministic and well-understood:
```
T_HK2 = T_setpoint + curve_rise × (T_ref - T_outdoor)
```

What we DON'T understand is how indoor temperature depends on T_HK2 history.
Therefore, the pilot maximizes **T_HK2 spread** rather than raw parameter spread.

Historical data limitations:
- Comfort setpoint: 20.2-21.0°C (0.8°C range)
- Eco setpoint: 18.0-18.3°C (0.3°C range)
- Curve rise: 0.97-1.14 (0.17 range)
- Result: eco_setpoint p=0.087 and comfort_hours p=0.34 (NOT significant)

### E.2 Pilot Design

| Aspect | Value |
|--------|-------|
| **Type** | T_HK2-targeted design (optimizes flow temp spread) |
| **Duration** | 10 weeks (January 13 - March 23, 2026) |
| **Block length** | 7 days (all data used with dynamical analysis) |
| **Total blocks** | 10 |
| **Randomization** | Random sequence assignment |
| **Analysis** | Dynamical (preferred) or RSM (comparison) |

**Note on Washout Periods:** With the dynamical (grey-box) analysis approach,
washout periods are unnecessary. The model explicitly handles non-equilibrium
states, and transitions between parameter settings are treated as informative
step response experiments. All 7 days of each block are used for analysis.

### E.3 T_HK2 Spread (Reference T_outdoor = 5°C)

| Mode | Min T_HK2 | Max T_HK2 | Spread |
|------|-----------|-----------|--------|
| Comfort | 32.1°C | 41.6°C | 9.5°C |
| Eco | 25.3°C | 36.0°C | 10.7°C |

### E.4 Parameter Bounds

| Parameter | Min | Max | Role in Design |
|-----------|-----|-----|----------------|
| comfort_setpoint | 19.0°C | 22.0°C | Varies T_HK2 comfort |
| eco_setpoint | 14.0°C | 19.0°C | Varies T_HK2 eco |
| curve_rise | 0.80 | 1.20 | Varies T_HK2 slope |
| comfort_hours | 8h | 16h | Orthogonal to T_HK2 |

### E.5 Safety Constraints

| Constraint | Pilot Threshold | Main Study Threshold |
|------------|-----------------|----------------------|
| Minimum T_weighted | 17.0°C | 18.5°C |
| Maximum violation % | 50% | 5% |
| Minimum COP | 2.0 | 2.0 |

The pilot allows more aggressive exploration because the goal is data collection,
not optimization. If comfort drops below 16.5°C, the block should be aborted and
baseline settings restored.

### E.6 Analysis Plan

Two analysis approaches are available:

#### E.6.1 Dynamical Analysis (Preferred)

Uses the grey-box state-space model on continuous 15-min data. No washout exclusion.

**Model equations:**
```
T_buffer[k+1] = T_buffer[k] + (dt/τ_buf) × [(T_HK2[k] - T_buffer[k]) - r_emit×(T_buffer[k] - T_room[k])]
T_room[k+1] = T_room[k] + (dt/τ_room) × [r_heat×(T_buffer[k] - T_room[k]) - (T_room[k] - T_outdoor[k])] + k_solar×PV[k]
```

**Why preferred:**
- Uses ALL data (~6,700 points vs 10 block averages)
- Transitions are informative step responses, not noise to discard
- Estimates physical parameters (τ_buf, τ_room, r_heat, r_emit)
- Computes steady-state gain: ∂T_room/∂T_HK2
- Validates model on held-out blocks

**Key outputs:**
- `dynamical_model_params.json` - Fitted grey-box parameters
- `step_response_analysis.csv` - Metrics at each parameter transition
- `fig5.01_dynamical_model.png` - Model fit visualization
- `fig5.02_step_responses.png` - Step response characteristics

#### E.6.2 RSM Analysis (Comparison)

Uses Response Surface Methodology on block-averaged metrics. Traditional approach with washout.

**Primary Model (T_HK2-based):**
```
T_indoor = b0 + b1×T_HK2_comfort + b2×T_HK2_eco + b3×comfort_hours + b4×T_outdoor
```

**Comparison Model (raw parameters):**
```
T_indoor = b0 + b1×comfort_sp + b2×eco_sp + b3×curve_rise + b4×hours + b5×T_outdoor
```

#### E.6.3 Key Questions

1. What is the thermal transfer function (T_indoor response to T_HK2)?
2. What are the building time constants (τ_buf, τ_room)?
3. How accurately can we predict T_room trajectories during transitions?
4. Does schedule duration matter independently of T_HK2?

### E.7 Commands

```bash
# Generate design and schedule
python src/phase5_pilot/run_pilot.py

# Use different reference outdoor temperature
python src/phase5_pilot/run_pilot.py --ref-outdoor 3

# Run analysis (after collecting pilot data)
python src/phase5_pilot/run_pilot.py --analyze       # Dynamical analysis (preferred)
python src/phase5_pilot/run_pilot.py --analyze-rsm   # RSM analysis (comparison)

# Run analysis scripts directly
python src/phase5_pilot/04_dynamical_analysis.py     # Grey-box model on continuous data
python src/phase5_pilot/03_pilot_analysis.py         # RSM on block averages
python src/phase5_pilot/03_pilot_analysis.py --block 5  # RSM through block 5 only

# View schedule and reports
open output/phase5_pilot/pilot_protocol.html
open output/phase5_pilot/dynamical_analysis_report.html
```

### E.8 Expected Outcomes

1. **Validated grey-box model**: Confirm the state-space model predicts T_room accurately
   - Target: R² > 0.95 on continuous data
   - Validate on held-out blocks (forward simulation test)

2. **Physical parameter estimates**: Refine time constants from pilot data
   - τ_buf (buffer tank): expected 1-4 hours
   - τ_room (building): expected 20-80 hours
   - Compare with Phase 3 historical estimates

3. **Steady-state gain**: Quantify ∂T_room/∂T_HK2
   - How much does room temperature change per degree of flow temperature?
   - Use for strategy optimization

4. **Step response characteristics**: Analyze transitions between settings
   - Empirical time constants from step responses
   - Prediction accuracy at each transition
   - Validate that transitions provide useful information (not noise)

5. **Informed Phase 5 design**:
   - If model validates well: use dynamical analysis for main study too
   - If model struggles: fall back to traditional washout + block averages
   - Update strategy definitions based on pilot learnings

### E.9 Implications for Main Phase 5 Study

| If Pilot Shows... | Then Main Study Should... |
|-------------------|---------------------------|
| Grey-box R² > 0.95 | Use dynamical analysis on all data |
| Good step response predictions | Reduce or eliminate washout periods |
| τ_room < 24h | Shorten block length to 5 days |
| τ_room > 48h | Keep 7-day blocks, may extend |
| Model fails at transitions | Keep traditional 3-day washout |

---

*Document version: 2.4*
*Created: January 2026*
*Updated: January 2026 (Added dynamical analysis approach in Appendix E)*
*Author: ESTAT Project*
