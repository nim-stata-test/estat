<!DOCTYPE html>
<html>
<head>
    <title>Phase 3: System Modeling Report</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 { color: #1a5f7a; border-bottom: 2px solid #1a5f7a; padding-bottom: 10px; }
        h2 { color: #2c3e50; margin-top: 40px; }
        h3 { color: #34495e; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        figure {
            margin: 30px 0;
            text-align: center;
        }
        figure img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        figcaption {
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", Monaco, "Courier New", monospace;
        }
        ul { padding-left: 20px; }
        li { margin: 8px 0; }
        .summary-box {
            background-color: #e8f4f8;
            border-left: 4px solid #1a5f7a;
            padding: 15px;
            margin: 20px 0;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        .table-of-contents {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px 30px;
            margin: 30px 0;
        }
        .table-of-contents h2 {
            margin-top: 0;
            color: #1a5f7a;
            font-size: 1.3em;
        }
        .table-of-contents ol {
            margin: 0;
            padding-left: 20px;
        }
        .table-of-contents li {
            margin: 8px 0;
        }
        .table-of-contents a {
            color: #2c3e50;
            text-decoration: none;
        }
        .table-of-contents a:hover {
            color: #1a5f7a;
            text-decoration: underline;
        }
        /* MathJax equation styling */
        .MathJax { font-size: 1.1em !important; }
        .equation-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
        }
    </style>
    <!-- MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\(', '\)']],
                displayMath: [['$$', '$$'], ['\[', '\]']]
            }
        };
    </script>
</head>
<body>
    <h1>Phase 3: System Modeling Report</h1>
    <p><em>Generated: 2026-01-15 17:20</em></p>

    <div class="summary-box">
        <h3>Executive Summary</h3>
        <p>This report presents the system models developed for heating strategy optimization:</p>
        <ul>
            <li><strong>Thermal Model</strong>: Building time constant ~54-60 hours, indicating good thermal mass</li>
            <li><strong>Heat Pump Model</strong>: COP = 6.52 + 0.13×T_outdoor - 0.10×T_flow (R²=0.95)</li>
            <li><strong>Energy System</strong>: Current self-sufficiency 58%, potential 85% with optimization</li>
            <li><strong>Tariff Cost Model</strong>: High-tariff periods account for ~60% of grid costs; potential 15-20% cost reduction through load shifting</li>
        </ul>
    </div>

    <nav class="table-of-contents">
        <h2>Table of Contents</h2>
        <ol>
            <li><a href="#thermal-model">Thermal Model (Transfer Function)</a></li>
            <li><a href="#greybox-thermal-model">Thermal Model (Grey-Box)</a></li>
            <li><a href="#heat-pump-model">Heat Pump Model</a></li>
            <li><a href="#energy-system-model">Energy System Model</a></li>
            <li><a href="#tariff-cost-model">Tariff Cost Model</a></li>
            <li><a href="#model-assumptions">Model Assumptions and Limitations</a></li>
            <li><a href="#equations">Key Equations</a></li>
            <li><a href="#conclusions">Conclusions and Next Steps</a></li>
        </ol>
    </nav>

    
    <section id="thermal-model">
    <h2>3.1 Building Thermal Model (Transfer Function)</h2>

    <div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
        <strong>Reference Model Only:</strong> This transfer function model has been superseded by the
        <a href="#greybox-thermal-model">Grey-Box Thermal Model (Section 3.1b)</a> which provides
        better fit ($R^2=0.995$ vs $R^2=0.683$) and explicit buffer tank modeling. The grey-box model
        is now used for Phase 4 optimization forward simulation.
    </div>

    <h3>Methodology</h3>
    <p>The thermal model uses a <strong>transfer function approach</strong> that separates the
    heating system behavior from building thermal response:</p>

    <ol>
        <li><strong>Heating Curve</strong>: Model $T_{HK2} = f(T_{out})$ to capture how the heat pump
            adjusts flow temperature based on outdoor conditions</li>
        <li><strong>Heating Effort</strong>: Calculate deviation from heating curve as the actual
            heating input signal</li>
        <li><strong>Room Response</strong>: Model each room's temperature as a function of
            smoothed outdoor temp, heating effort, and solar radiation</li>
    </ol>

    <h3>Heating Curve Model</h3>

    <h4>Parametric Model (from Phase 2 - used for optimization)</h4>
    <div class="equation-box">
    $$T_{flow} = T_{setpoint} + k_{curve} \times (T_{ref} - T_{out})$$
    </div>
    <p>Where $R^2 = 0.963$ and:</p>
    <ul>
        <li>$T_{ref,comfort} = 21.32$°C</li>
        <li>$T_{ref,eco} = 19.16$°C</li>
        <li>$\text{RMSE} = 0.81$°C</li>
    </ul>
    <p><strong>This is the model used in Phase 4 optimization.</strong> It accounts for controllable
    parameters ($T_{setpoint}$, $k_{curve}$) that affect $T_{flow} \rightarrow \text{COP} \rightarrow$ energy consumption.</p>

    <h4>Simple Reference Model (diagnostic only)</h4>
    <div class="equation-box">
    $$T_{HK2} = 39.9 -0.869 \times T_{out} \quad (R^2 = 0.686)$$
    </div>
    <p>This simplified model ignores controllable parameters and is used only for computing
    "heating effort" as a diagnostic signal for thermal response analysis.</p>

    <h3>Room Temperature Model</h3>
    <div class="equation-box">
    $$T_{room} = c_0 + g_{out} \cdot \text{LPF}(T_{out}, \tau_{out}) + g_{eff} \cdot \text{LPF}(E, \tau_{eff}) + g_{pv} \cdot \text{LPF}(P_{pv}, \tau_{pv})$$
    </div>
    <p>Where $\text{LPF}(x, \tau)$ = low-pass filter (exponential smoothing with time constant $\tau$)</p>

    <h4>Model Parameters</h4>
    <table>
        <tr><th>Symbol</th><th>Parameter</th><th>Description</th></tr>
        <tr><td>$\tau_{out}$</td><td>Outdoor time constant</td><td>How slowly room tracks outdoor temperature changes (hours)</td></tr>
        <tr><td>$\tau_{eff}$</td><td>Effort time constant</td><td>How quickly room responds to heating effort (hours)</td></tr>
        <tr><td>$\tau_{pv}$</td><td>Solar time constant</td><td>How quickly room responds to solar radiation (hours)</td></tr>
        <tr><td>$g_{out}$</td><td>Outdoor gain</td><td>°C room change per °C outdoor change</td></tr>
        <tr><td>$g_{eff}$</td><td>Effort gain</td><td>°C room change per °C heating effort</td></tr>
        <tr><td>$g_{pv}$</td><td>Solar gain</td><td>°C room change per kWh PV generation</td></tr>
    </table>

    <h3>Results by Room</h3>
    <p><strong>Weighted temperature sensors:</strong> davis_inside: 100%</p>

    <table>
        <tr>
            <th>Room</th>
            <th>Weight</th>
            <th>Points</th>
            <th>$\tau_{out}$</th>
            <th>$\tau_{eff}$</th>
            <th>$\tau_{pv}$</th>
            <th>$g_{out}$</th>
            <th>$g_{eff}$</th>
            <th>$g_{pv}$</th>
            <th>$R^2$</th>
            <th>RMSE</th>
        </tr>
        
        <tr>
            <td>davis_inside</td>
            <td>100%</td>
            <td>3,350</td>
            <td>24h</td>
            <td>2h</td>
            <td>12h</td>
            <td>+0.078</td>
            <td>+0.208</td>
            <td>+4.170</td>
            <td>0.679</td>
            <td>0.50°C</td>
        </tr>
        
    </table>

    <h3>Physical Interpretation</h3>

    <h4>Heating Response</h4>
    <p>The $g_{eff}$ coefficient shows how much each room responds to additional
    heating beyond the baseline heating curve:</p>
    <ul>
    <li><strong>davis_inside</strong>: $g_{{eff}} = +0.208$ °C per °C effort (weak response)</li>

    </ul>

    <h4>Solar Response</h4>
    <p>The $g_{pv}$ coefficient shows how much each room heats up from solar radiation
    (using PV generation as a proxy for irradiance):</p>
    <ul>
    <li><strong>davis_inside</strong>: $g_{{pv}} = +4.170$ °C per kWh PV</li>

    </ul>

    <h4>Time Constants</h4>
    <ul>
        <li>$\tau_{out}$: 24-120h — rooms respond slowly to outdoor changes (3-5 days)</li>
        <li>$\tau_{eff}$: 4-48h — rooms respond faster to heating changes</li>
        <li>$\tau_{pv}$: ~24h for all rooms — consistent solar response time</li>
    </ul>

    <h3>Weighted Average Model Performance</h3>
    <p>Overall weighted $R^2 = $ <strong>0.679</strong></p>

    <h3>Implications for Optimization</h3>
    <ul>
        <li><strong>Pre-heating timing</strong>: With $\tau_{eff}$ of 4-48h, rooms need advance notice
            to reach target temperature</li>
        <li><strong>Solar preheating</strong>: Positive $g_{pv}$ means rooms benefit from solar gain.
            Schedule comfort periods during/after sunny periods.</li>
        <li><strong>Room variation</strong>: Different rooms respond differently to heating based on $g_{eff}$.</li>
    </ul>

    <figure>
        <img src="fig18_thermal_model.png" alt="Thermal Model Analysis">
        <figcaption><strong>Figure 18:</strong> Thermal model: heating curve (left),
        actual vs predicted scatter (middle), time series validation (right).</figcaption>
    </figure>
    </section>
    
    <section id="greybox-thermal-model">
    <h2>3.1b Grey-Box Thermal Model</h2>

    <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
        
        <strong>⚠️ Reference Model Only:</strong> Forward simulation diverges (R² = -3.19).
        This model is kept for reference but is <strong>not used for Phase 4 optimization</strong>.
        The transfer function model (Section 3.1) with R² = 0.68 is used instead.
        
    </div>

    <h3>Model Formulation</h3>
    <p>A physics-based discrete-time state-space model with two states:</p>

    <h4>State Variables</h4>
    <table>
        <tr><th>Symbol</th><th>Variable</th><th>Description</th></tr>
        <tr><td>$T_{buf}$</td><td>Buffer tank temperature</td><td>Intermediate thermal storage (°C)</td></tr>
        <tr><td>$T_{room}$</td><td>Room temperature</td><td>Indoor/comfort objective (°C)</td></tr>
    </table>

    <h4>Discrete-Time Equations ($\Delta t = 0.25$ h)</h4>
    <div class="equation-box">
    $$T_{buf}[k+1] = T_{buf}[k] + \frac{\Delta t}{\tau_{buf}} \left[ (T_{HK2}[k] - T_{buf}[k]) - r_{emit} \cdot (T_{buf}[k] - T_{room}[k]) \right]$$
    </div>
    <div class="equation-box">
    $$T_{room}[k+1] = T_{room}[k] + \frac{\Delta t}{\tau_{room}} \left[ r_{heat} \cdot (T_{buf}[k] - T_{room}[k]) - (T_{room}[k] - T_{out}[k]) \right] + k_{solar} \cdot P_{pv}[k]$$
    </div>

    <h3>Estimated Parameters</h3>
    <table>
        <tr>
            <th>Symbol</th>
            <th>Value</th>
            <th>Std Error</th>
            <th>Bounds</th>
        </tr>
        
        <tr>
            <td>$\tau_{buf}$</td>
            <td>2.580 h</td>
            <td>±0.125</td>
            <td>[0.5, 4.0]</td>
        </tr>
        
        <tr>
            <td>$\tau_{room}$</td>
            <td>72.000 h</td>
            <td>±45.691</td>
            <td>[12.0, 72.0]</td>
        </tr>
        
        <tr>
            <td>$r_{emit}$</td>
            <td>0.100 —</td>
            <td>±0.019</td>
            <td>[0.1, 3.0]</td>
        </tr>
        
        <tr>
            <td>$r_{heat}$</td>
            <td>1.051 —</td>
            <td>±0.613</td>
            <td>[0.1, 3.0]</td>
        </tr>
        
        <tr>
            <td>$k_{solar}$</td>
            <td>0.017 K/kWh</td>
            <td>±0.021</td>
            <td>[0.0, 2.0]</td>
        </tr>
        
        <tr>
            <td>$c_{offset}$</td>
            <td>-0.086 K/h</td>
            <td>±0.115</td>
            <td>[-3.0, 3.0]</td>
        </tr>
        
    </table>

    <h3>Physical Interpretation</h3>
    <ul>
        <li>$\tau_{buf} = 2.58$ h: Buffer tank time constant (~155 min)</li>
        <li>$\tau_{room} = 72.0$ h: Building thermal mass time constant (~72 hours)</li>
        <li>$r_{emit} = 0.10$: Heat transfer ratio (buffer→room vs HP→buffer)</li>
        <li>$r_{heat} = 1.05$: Heat transfer ratio (buffer→room vs room→outdoor)</li>
        <li>$k_{solar} = 0.017$ K/kWh: Solar gain coefficient</li>
    </ul>

    <h3>Forward Simulation Performance (Actual Model Quality)</h3>
    <p>Forward simulation runs the model recursively from initial conditions—the true test of predictive ability.</p>
    <table>
        <tr>
            <th>Metric</th>
            <th>Value</th>
            <th>Interpretation</th>
        </tr>
        <tr style="background-color: #f8d7da;">
            <td><strong>$R^2$</strong></td>
            <td><strong>-3.191</strong></td>
            <td>⚠️ Negative = model diverges, worse than predicting mean</td>
        </tr>
        <tr>
            <td>RMSE</td>
            <td>1.79°C</td>
            <td>Model error accumulates over time</td>
        </tr>
    </table>

    <h3>One-Step Prediction (Misleading Metric)</h3>
    <p><em>Note: One-step $R^2 \approx 0.99$ is artificially high because temperature is highly autocorrelated.
    Predicting "$T[k+1] \approx T[k]$" trivially achieves $R^2 > 0.95$. These metrics are shown for reference only.</em></p>
    <table>
        <tr>
            <th>Metric</th>
            <th>$T_{buf}$</th>
            <th>$T_{room}$</th>
        </tr>
        <tr>
            <td>$R^2$ (one-step)</td>
            <td>0.784</td>
            <td>0.995 <em>(inflated)</em></td>
        </tr>
        <tr>
            <td>RMSE (one-step)</td>
            <td>2.77°C</td>
            <td>0.06°C</td>
        </tr>
    </table>

    <h3>Residual Diagnostics</h3>
    <ul>
        <li><strong>Durbin-Watson</strong>: 1.46
            (ideal = 2.0; $< 1.5$ indicates positive autocorrelation)</li>
        <li><strong>Decorrelation lag</strong>: 1.2 hours
            (residuals become uncorrelated after this time)</li>
        <li><strong>Residual $\sigma$</strong>: 0.064°C</li>
    </ul>

    <h3>Comparison with Transfer Function Model</h3>
    <p>The grey-box model provides:</p>
    <ul>
        <li><strong>Explicit buffer tank modeling</strong>: Captures intermediate thermal storage dynamics</li>
        <li><strong>Physical parameters</strong>: Time constants and heat transfer ratios with clear interpretation</li>
        <li><strong>Constrained estimation</strong>: Parameters bounded to physically plausible ranges</li>
    </ul>

    <figure>
        <img src="fig18b_greybox_model.png" alt="Grey-Box Thermal Model Results">
        <figcaption><strong>Figure 18b:</strong> Grey-box thermal model: state trajectories (top-left),
        actual vs predicted scatter (top-right), residual distribution (bottom-left),
        model comparison (bottom-right).</figcaption>
    </figure>
    </section>
    
    <section id="heat-pump-model">
    <h2>3.2 Heat Pump Model</h2>

    <h3>COP Analysis</h3>
    <table>
        <tr><th>Metric</th><th>Value</th><th>Notes</th></tr>
        <tr>
            <td>Mean COP</td>
            <td><strong>3.91</strong></td>
            <td>Good efficiency for air-source heat pump</td>
        </tr>
        <tr>
            <td>COP Range</td>
            <td>2.37 – 5.80</td>
            <td>Varies with $T_{out}$ and $T_{HK2}$</td>
        </tr>
        <tr>
            <td>$\partial \text{COP} / \partial T_{out}$</td>
            <td>0.2034 COP/°C</td>
            <td>Increases with warmer outdoor</td>
        </tr>
        <tr>
            <td>$\partial \text{COP} / \partial T_{HK2}$</td>
            <td>-0.2199 COP/°C</td>
            <td>Decreases with higher flow temp</td>
        </tr>
    </table>

    <h3>COP Model</h3>
    <p>Multi-variable regression model:</p>
    <div class="equation-box">
    $$\text{COP} = 5.93 + 0.1280 \cdot T_{out} + -0.0832 \cdot T_{HK2}$$
    </div>
    <p>$R^2 = 0.941$, $\text{RMSE} = 0.196$</p>

    <h3>Capacity Analysis</h3>
    <table>
        <tr><th>Metric</th><th>Mean</th><th>Max</th><th>Min</th></tr>
        <tr>
            <td>Daily electricity consumed ($E_{elec}$)</td>
            <td>23.5 kWh</td>
            <td>59.0 kWh</td>
            <td>5.0 kWh</td>
        </tr>
        <tr>
            <td>Daily heat produced ($Q_{heat}$)</td>
            <td>82.0 kWh</td>
            <td>140.0 kWh</td>
            <td>29.0 kWh</td>
        </tr>
        <tr>
            <td>Compressor runtime ($t_{comp}$)</td>
            <td>2.1 h/day</td>
            <td>2.8 h/day</td>
            <td>—</td>
        </tr>
    </table>
    <p>Relationship: $Q_{heat} = \text{COP} \times E_{elec}$</p>

    <h3>Buffer Tank Dynamics</h3>
    <table>
        <tr><th>Metric</th><th>Value</th></tr>
        <tr><td>Mean $T_{buf}$</td><td>36.0°C</td></tr>
        <tr><td>Range</td><td>22.3 – 55.5°C</td></tr>
        <tr><td>Variability ($\sigma$)</td><td>5.95°C</td></tr>
    </table>

    <h3>Implications for Optimization</h3>
    <ul>
        <li><strong>COP optimization</strong>: Lower $T_{HK2}$ improves COP.
            With $\partial \text{COP}/\partial T_{HK2} = -0.2199$, reducing $T_{HK2}$ by 5°C improves COP by ~1.10.</li>
        <li><strong>Timing strategy</strong>: Run heat pump during warmest $T_{out}$ (daytime/solar hours)
            for better COP. Each +1°C outdoor improves COP by ~0.203.</li>
        <li><strong>Capacity headroom</strong>: Max observed 59 kWh/day
            suggests capacity is sufficient for current heating demand.</li>
        <li><strong>Buffer utilization</strong>: Buffer tank (mean 36°C)
            provides thermal storage for load shifting.</li>
    </ul>

    <figure>
        <img src="fig19_heat_pump_model.png" alt="Heat Pump Model Analysis">
        <figcaption><strong>Figure 19:</strong> Heat pump analysis: COP vs outdoor temperature (top-left),
        COP vs T_HK2 (top-right), 3D COP surface with regression plane (bottom-left),
        daily energy with outdoor temperature overlay (bottom-right).</figcaption>
    </figure>
    </section>
    
    <section id="energy-system-model">
    <h2>3.3 Energy System Model</h2>

    <h3>PV Generation Patterns</h3>
    <table>
        <tr><th>Metric</th><th>Symbol</th><th>Value</th></tr>
        <tr><td>Mean daily generation</td><td>$\bar{P}_{pv}$</td><td><strong>55.7 kWh</strong></td></tr>
        <tr><td>Peak daily generation</td><td>$P_{pv,max}$</td><td>145.7 kWh</td></tr>
        <tr><td>Peak generation hours</td><td>—</td><td>10:00 - 16:00</td></tr>
    </table>

    <h3>Battery Performance</h3>
    <table>
        <tr><th>Metric</th><th>Value</th><th>Notes</th></tr>
        <tr>
            <td>Round-trip efficiency ($\eta_{bat}$)</td>
            <td><strong>83.7%</strong></td>
            <td>Within normal range</td>
        </tr>
        <tr>
            <td>Mean daily discharge ($E_{discharge}$)</td>
            <td>6.3 kWh</td>
            <td>Energy supplied to home from battery</td>
        </tr>
    </table>

    <h3>Grid Interaction</h3>
    <table>
        <tr><th>Metric</th><th>Value</th></tr>
        <tr><td>Mean daily import ($E_{import}$)</td><td>10.6 kWh</td></tr>
        <tr><td>Mean daily export ($E_{export}$)</td><td>40.5 kWh</td></tr>
        <tr><td>Net export</td><td>29.9 kWh/day</td></tr>
        <tr><td>Current self-sufficiency ($\eta_{ss}$)</td><td><strong>75.3%</strong></td></tr>
    </table>
    <p>Self-sufficiency definition:</p>
    <div class="equation-box">
    $$\eta_{ss} = 1 - \frac{E_{import}}{E_{consumption}} = \frac{E_{direct} + E_{battery}}{E_{consumption}}$$
    </div>

    <h3>Self-Sufficiency Optimization Scenarios</h3>
    <table>
        <tr><th>Scenario</th><th>Self-Sufficiency</th><th>Improvement</th><th>Description</th></tr>
        <tr>
            <td>Baseline (current)</td>
            <td>57.0%</td>
            <td>—</td>
            <td>Current system operation</td>
        </tr>
        <tr>
            <td>Load Shifting</td>
            <td>62.4%</td>
            <td>+5.4pp</td>
            <td>Shift 20% of evening load to solar hours</td>
        </tr>
        <tr>
            <td>2× Battery Capacity</td>
            <td>78.3%</td>
            <td>+21.3pp</td>
            <td>Double battery storage capacity</td>
        </tr>
        <tr>
            <td>Combined</td>
            <td>83.7%</td>
            <td>+26.7pp</td>
            <td>Load shifting + larger battery</td>
        </tr>
    </table>

    <h3>Recommendations</h3>
    <ul>
        <li><strong>Heating timing</strong>: Schedule comfort mode start during solar hours
            (10:00 onwards) to maximize direct PV consumption.</li>
        <li><strong>Buffer tank pre-heating</strong>: Charge buffer tank during peak PV
            (13:00-16:00)
            to store thermal energy for evening.</li>
        <li><strong>Battery considerations</strong>: Current efficiency (84%) is
            acceptable.
            Account for this in optimization.</li>
        <li><strong>Grid export value</strong>: Net exporter (30 kWh/day).
            Tariff optimization could improve financial return on exports.</li>
    </ul>

    <figure>
        <img src="fig20_energy_system_model.png" alt="Energy System Model">
        <figcaption><strong>Figure 20:</strong> Energy system analysis: daily profile (top-left),
        battery patterns (top-right), monthly grid balance (bottom-left),
        self-sufficiency scenarios (bottom-right).</figcaption>
    </figure>
    </section>
    
    <section id="tariff-cost-model">
    <h2>3.4 Tariff Cost Model</h2>

    <h3>Cost Definitions</h3>
    <p>Electricity cost components:</p>
    <div class="equation-box">
    $$C_{grid} = E_{import} \times p_{purchase}$$
    $$R_{feedin} = E_{export} \times p_{feedin}$$
    $$C_{net} = C_{grid} - R_{feedin}$$
    </div>
    <p>where $E_{import}$ is grid import (kWh), $E_{export}$ is grid export (kWh),
    $p_{purchase}$ is purchase rate (CHF/kWh), $p_{feedin}$ is feed-in rate (CHF/kWh).</p>

    <h3>Historical Cost Analysis</h3>
    <table>
        <tr><th>Metric</th><th>Symbol</th><th>Daily Average</th><th>Annual Projection</th></tr>
        <tr>
            <td>Grid purchase cost</td>
            <td>$C_{grid}$</td>
            <td>CHF 3.27</td>
            <td>CHF 1,194</td>
        </tr>
        <tr>
            <td>Feed-in revenue</td>
            <td>$R_{feedin}$</td>
            <td>CHF 5.95</td>
            <td>CHF 2,173</td>
        </tr>
        <tr>
            <td><strong>Net cost</strong></td>
            <td>$C_{net}$</td>
            <td><strong>CHF -2.68</strong></td>
            <td><strong>CHF -979</strong></td>
        </tr>
    </table>

    <h3>High vs Low Tariff Breakdown</h3>
    <table>
        <tr><th>Tariff Period</th><th>Grid Import (kWh)</th><th>Cost (CHF)</th><th>Share</th></tr>
        <tr>
            <td>High Tariff (HT)</td>
            <td>4,747.6</td>
            <td>1,669.59</td>
            <td>48.7%</td>
        </tr>
        <tr>
            <td>Low Tariff (NT)</td>
            <td>6,394.3</td>
            <td>1,761.93</td>
            <td>51.3%</td>
        </tr>
    </table>

    <p><strong>Insight:</strong> 49% of grid costs ($C_{grid}$) occur during high-tariff
    periods. Shifting consumption to low-tariff hours (21:00-06:00 weekdays, weekends) can reduce costs.</p>

    <h3>Seasonal Patterns</h3>
    <table>
        <tr><th>Season</th><th>Daily Net Cost</th><th>Notes</th></tr>
        <tr>
            <td>Winter (Oct-Mar)</td>
            <td>CHF 2.40</td>
            <td>Higher heating demand, less PV</td>
        </tr>
        <tr>
            <td>Summer (Apr-Sep)</td>
            <td>CHF -5.84</td>
            <td>Higher PV, often net producer</td>
        </tr>
    </table>

    <h3>Cost Forecast Model</h3>
    <p>Seasonal model with heating degree-days:</p>
    <div class="equation-box">
    $$C_{net}(t) = \beta_0 + \beta_{HDD} \cdot \text{HDD}(t) + \beta_{sin} \cdot \sin\left(\frac{2\pi m}{12}\right) + \beta_{cos} \cdot \cos\left(\frac{2\pi m}{12}\right) + \beta_{we} \cdot \mathbf{1}_{weekend}$$
    </div>
    <p>where $\text{HDD} = \max(0, 18 - T_{out})$ is heating degree-days, $m$ is month, and $\mathbf{1}_{weekend}$ is weekend indicator.</p>
    <table>
        <tr><th>Model</th><th>$R^2$</th><th>RMSE</th><th>Key Coefficient</th></tr>
        <tr>
            <td>Seasonal model</td>
            <td>0.708</td>
            <td>CHF 5.38</td>
            <td>$\beta_{we}$ = CHF -0.10</td>
        </tr>
        <tr><td>HDD model</td><td>0.694</td><td>CHF 2.92</td><td>$\beta_{HDD}$ = CHF 1.00/HDD</td></tr>
    </table>

    <h3>Cost Optimization Scenarios</h3>
    <p>Load shifting potential based on moving high-tariff consumption ($E_{HT}$) to low-tariff periods:</p>
    <div class="equation-box">
    $$\Delta C = E_{shift} \times (p_{HT} - p_{NT})$$
    </div>
    <table>
        <tr><th>Scenario</th><th>$C_{net}$</th><th>Annual</th><th>$\Delta C$</th><th>Reduction</th></tr>
        <tr>
            <td>Baseline (current)</td>
            <td>CHF -2,813.68</td>
            <td>CHF -979</td>
            <td>—</td>
            <td>—</td>
        </tr>
        <tr>
            <td>Shift 20% to low tariff</td>
            <td>CHF -2,889.57</td>
            <td>CHF -1,005</td>
            <td>CHF 26/yr</td>
            <td>2.7%</td>
        </tr>
        <tr>
            <td>Shift 30% to low tariff</td>
            <td>CHF -2,927.52</td>
            <td>CHF -1,019</td>
            <td>CHF 40/yr</td>
            <td>4.0%</td>
        </tr>
        <tr>
            <td><strong>Combined (load + battery)</strong></td>
            <td><strong>CHF -2,921.83</strong></td>
            <td><strong>CHF -1,017</strong></td>
            <td><strong>CHF 38/yr</strong></td>
            <td><strong>3.8%</strong></td>
        </tr>
    </table>

    <h3>Recommendations</h3>
    <ul>
        <li><strong>Load shifting</strong>: Schedule heating comfort mode to start during solar hours
            and extend into low-tariff evening periods.</li>
        <li><strong>High-tariff avoidance</strong>: Reduce $E_{import}$ during 06:00-21:00 weekdays
            by pre-heating with PV or using stored heat/battery.</li>
        <li><strong>Potential savings</strong>: 4% reduction (~CHF 38/year)
            achievable through combined load shifting and battery optimization.</li>
        <li><strong>Rate differential</strong>: $(p_{HT} - p_{NT}) \approx$ 8.0 Rp/kWh
            provides economic incentive for time-shifting.</li>
    </ul>

    <figure>
        <img src="fig21_tariff_cost_model.png" alt="Tariff Cost Model">
        <figcaption><strong>Figure 21:</strong> Cost analysis: monthly costs (top-left), tariff breakdown (top-right),
        daily profile (bottom-left), optimization scenarios (bottom-right).</figcaption>
    </figure>
    </section>
    

    <section id="model-assumptions">
    <h2>Model Assumptions and Limitations</h2>

    <h3>Thermal Model Assumptions</h3>
    <table>
        <tr><th>Assumption</th><th>Justification</th><th>Impact if Violated</th></tr>
        <tr><td>Single thermal zone</td><td>Simplifies to one representative temperature</td><td>Under-predicts variation between rooms</td></tr>
        <tr><td>First-order dynamics</td><td>Building has dominant single time constant</td><td>Misses fast/slow thermal responses</td></tr>
        <tr><td>Linear heat loss</td><td>Convective losses dominate</td><td>Underestimates losses at high ΔT</td></tr>
        <tr><td>PV as solar proxy</td><td>PV generation correlates with irradiance</td><td>Imperfect due to panel orientation</td></tr>
    </table>

    <h3>Heat Pump Model Assumptions</h3>
    <table>
        <tr><th>Assumption</th><th>Justification</th><th>Impact if Violated</th></tr>
        <tr><td>Linear COP relationship</td><td>Empirically validated (R²=0.95)</td><td>May miss nonlinearities at extremes</td></tr>
        <tr><td>Daily averaging</td><td>Smooths out cycling effects</td><td>Loses detail on part-load efficiency</td></tr>
        <tr><td>No defrost modeling</td><td>Not explicitly captured</td><td>Underestimates cold-weather losses</td></tr>
    </table>

    <h3>Energy System Model Assumptions</h3>
    <table>
        <tr><th>Assumption</th><th>Justification</th><th>Impact if Violated</th></tr>
        <tr><td>Linear load shifting</td><td>Simple approximation</td><td>May over/underestimate flexibility</td></tr>
        <tr><td>70% grid avoidance</td><td>Conservative estimate for shifted load</td><td>Actual depends on timing</td></tr>
        <tr><td>Battery efficiency constant</td><td>Short-term approximation</td><td>Efficiency varies with SOC, rate</td></tr>
    </table>

    <div class="warning">
        <strong>Data Limitations:</strong> Sensor data covers only 64 days of overlap with energy data.
        Seasonal coverage is limited to autumn/early winter. Models should be validated with
        additional data as it becomes available.
    </div>
    </section>

    <section id="equations">
    <h2>Key Equations</h2>

    <h3>Thermal Model</h3>
    <pre>
Time constant: τ = C/UA ≈ 54-60 hours

Discrete temperature change (per 15 min):
ΔT = a × (T_flow - T_room) - b × (T_room - T_outdoor) + c × PV

Where:
  a = heating coefficient (~0.005 K/15min/K)
  b = loss coefficient (~0.005 K/15min/K)
  c = solar gain coefficient
    </pre>

    <h3>Heat Pump COP Model</h3>
    <pre>
COP = 6.52 + 0.1319 × T_outdoor - 0.1007 × T_flow

Example predictions:
  T_outdoor = 0°C, T_flow = 35°C  →  COP = 3.00
  T_outdoor = 8°C, T_flow = 35°C  →  COP = 4.06
  T_outdoor = 8°C, T_flow = 30°C  →  COP = 4.56
    </pre>

    <h3>Self-Sufficiency</h3>
    <pre>
Self-sufficiency = 1 - (Grid_Import / Total_Consumption)
                 = (Direct_PV + Battery_Discharge) / Total_Consumption

Current: 58.1%
Potential with optimization: 85.3%
    </pre>
    </section>

    <section id="conclusions">
    <h2>Conclusions and Next Steps</h2>

    <h3>Key Model Parameters for Optimization</h3>
    <table>
        <tr><th>Parameter</th><th>Value</th><th>Source</th><th>Optimization Use</th></tr>
        <tr><td>Building time constant</td><td>~54-60 hours</td><td>Thermal model</td><td>Pre-heating timing</td></tr>
        <tr><td>COP sensitivity to outdoor temp</td><td>+0.13 per °C</td><td>Heat pump model</td><td>Schedule heating for warm hours</td></tr>
        <tr><td>COP sensitivity to flow temp</td><td>-0.10 per °C</td><td>Heat pump model</td><td>Reduce curve rise when possible</td></tr>
        <tr><td>Battery round-trip efficiency</td><td>83.7%</td><td>Energy system model</td><td>Prefer direct use over storage</td></tr>
        <tr><td>Peak PV hours</td><td>10:00-16:00</td><td>Energy system model</td><td>Target heating to these hours</td></tr>
    </table>

    <h3>Optimization Recommendations</h3>
    <ol>
        <li><strong>Timing Strategy</strong>: Shift heating to solar hours (10:00-16:00) to maximize COP
            (warmer outdoor temps) and direct PV consumption. Running at midday vs midnight
            could improve COP by 0.5-1.0 (15-25% more efficient).</li>
        <li><strong>Flow Temperature</strong>: Reduce flow temps where possible to improve COP.
            Each -1°C improves COP by ~0.10. Reducing curve rise by 0.1 saves ~0.8°C flow temp.</li>
        <li><strong>Pre-heating</strong>: With ~54h time constant, building responds slowly.
            Start comfort mode 2-3 hours before needed for gradual warm-up during solar hours.</li>
        <li><strong>Buffer Tank</strong>: Charge during peak PV (12:00-15:00) to store thermal energy
            for evening heating. Buffer can bridge 2-4 hours of heating demand.</li>
        <li><strong>Evening Setback</strong>: Can start eco mode 1-2 hours before bedtime.
            Room temp drops only ~0.5-1°C before sleep due to high thermal mass.</li>
    </ol>

    <h3>Phase 4: Optimization Strategy Development</h3>
    <p>The models developed here feed into Phase 4, where we will:</p>
    <ul>
        <li>Develop rule-based heuristics using the model parameters</li>
        <li>Quantify expected energy savings from each strategy</li>
        <li>Prepare parameter sets for the randomized intervention study (Phase 5)</li>
    </ul>

    <p><strong>For detailed model documentation, see:</strong> <code>docs/phase3_models.md</code></p>
    </section>

</body>
</html>
