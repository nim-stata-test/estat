
    <section id="thermal-model">
    <h2>3.1 Building Thermal Model</h2>

    <h3>Methodology</h3>
    <p>The thermal model uses a <strong>transfer function approach</strong> that separates the
    heating system behavior from building thermal response:</p>

    <ol>
        <li><strong>Heating Curve</strong>: Model T<sub>HK2</sub> = f(T<sub>out</sub>) to capture how the heat pump
            adjusts flow temperature based on outdoor conditions</li>
        <li><strong>Heating Effort</strong>: Calculate deviation from heating curve as the actual
            heating input signal</li>
        <li><strong>Room Response</strong>: Model each room's temperature as a function of
            smoothed outdoor temp, heating effort, and solar radiation</li>
    </ol>

    <h3>Heating Curve Model</h3>

    <h4>Parametric Model (from Phase 2 - used for optimization)</h4>
    <div class="equation-box">
    $$T_{flow} = T_{setpoint} + k_{curve} \times (T_{ref} - T_{out})$$
    </div>
    <p>Where R² = 0.946 and:</p>
    <ul>
        <li>T<sub>ref,comfort</sub> = 21.34°C</li>
        <li>T<sub>ref,eco</sub> = 19.16°C</li>
        <li>RMSE = 1.02°C</li>
    </ul>
    <p><strong>This is the model used in Phase 4 optimization.</strong> It accounts for controllable
    parameters (<em>T<sub>setpoint</sub></em>, <em>k<sub>curve</sub></em>) that affect T<sub>flow</sub> → COP → energy consumption.</p>

    <h4>Simple Reference Model (diagnostic only)</h4>
    <div class="equation-box">
    $$T_{HK2} = 39.7 -0.861 \times T_{out} \quad (R^2 = 0.575)$$
    </div>
    <p>This simplified model ignores controllable parameters and is used only for computing
    "heating effort" as a diagnostic signal for thermal response analysis.</p>

    <h3>Room Temperature Model</h3>
    <div class="equation-box">
    $$T_{room} = c_0 + g_{out} \cdot \text{LPF}(T_{out}, \tau_{out}) + g_{eff} \cdot \text{LPF}(E, \tau_{eff}) + g_{pv} \cdot \text{LPF}(P_{pv}, \tau_{pv})$$
    </div>
    <p>Where LPF(<em>x</em>, <em>τ</em>) = low-pass filter (exponential smoothing with time constant <em>τ</em>)</p>

    <h4>Model Parameters</h4>
    <table>
        <tr><th>Symbol</th><th>Parameter</th><th>Description</th></tr>
        <tr><td>τ<sub>out</sub></td><td>Outdoor time constant</td><td>How slowly room tracks outdoor temperature changes (hours)</td></tr>
        <tr><td>τ<sub>eff</sub></td><td>Effort time constant</td><td>How quickly room responds to heating effort (hours)</td></tr>
        <tr><td>τ<sub>pv</sub></td><td>Solar time constant</td><td>How quickly room responds to solar radiation (hours)</td></tr>
        <tr><td>g<sub>out</sub></td><td>Outdoor gain</td><td>°C room change per °C outdoor change</td></tr>
        <tr><td>g<sub>eff</sub></td><td>Effort gain</td><td>°C room change per °C heating effort</td></tr>
        <tr><td>g<sub>pv</sub></td><td>Solar gain</td><td>°C room change per kWh PV generation</td></tr>
    </table>

    <h3>Low-Pass Filter (LPF) Details</h3>
    <p>The model uses first-order exponential smoothing to capture thermal inertia.
    This is a discrete-time IIR filter with the difference equation:</p>
    <div class="equation-box">
    $$y[n] = \alpha \cdot x[n] + (1-\alpha) \cdot y[n-1]$$
    </div>
    <p>where <em>α</em> = 1 − e<sup>−1/τ</sup> and <em>τ</em> is the time constant in timesteps
    (multiply hours by 4 for 15-min data).</p>

    <h4>Time Constant Interpretation</h4>
    <table>
        <tr><th>Time</th><th>Response</th><th>Physical Meaning</th></tr>
        <tr><td>1τ</td><td>63.2%</td><td>Most of the response has occurred</td></tr>
        <tr><td>2τ</td><td>86.5%</td><td>Nearly at steady state</td></tr>
        <tr><td>3τ</td><td>95.0%</td><td>Effectively at steady state</td></tr>
        <tr><td>5τ</td><td>99.3%</td><td>Full response complete</td></tr>
    </table>

    <figure>
        <img src="fig3.01a_lpf_visualization.png" alt="Low-Pass Filter Visualization">
        <figcaption><strong>Figure 3.1a:</strong> Low-pass filter behavior: step response (left),
        impulse response/decay (middle), and filter equations (right).</figcaption>
    </figure>

    <h3>Results by Room</h3>
    <p><strong>Weighted temperature sensors:</strong> davis_inside: 100%</p>

    <table>
        <tr>
            <th>Room</th>
            <th>Weight</th>
            <th>Points</th>
            <th>τ<sub>out</sub></th>
            <th>τ<sub>eff</sub></th>
            <th>τ<sub>pv</sub></th>
            <th>g<sub>out</sub></th>
            <th>g<sub>eff</sub></th>
            <th>g<sub>pv</sub></th>
            <th>R²</th>
            <th>RMSE</th>
        </tr>
        
        <tr>
            <td>davis_inside</td>
            <td>100%</td>
            <td>3,665</td>
            <td>72h</td>
            <td>2h</td>
            <td>12h</td>
            <td>+0.089</td>
            <td>+0.200</td>
            <td>+3.821</td>
            <td>0.698</td>
            <td>0.51°C</td>
        </tr>
        
    </table>

    <h3>Physical Interpretation</h3>

    <h4>Heating Response</h4>
    <p>The g<sub>eff</sub> coefficient shows how much each room responds to additional
    heating beyond the baseline heating curve:</p>
    <ul>
    <li><strong>davis_inside</strong>: g<sub>eff</sub> = +0.200 °C per °C effort (weak response)</li>

    </ul>

    <h4>Solar Response</h4>
    <p>The g<sub>pv</sub> coefficient shows how much each room heats up from solar radiation
    (using PV generation as a proxy for irradiance):</p>
    <ul>
    <li><strong>davis_inside</strong>: g<sub>pv</sub> = +3.821 °C per kWh PV</li>

    </ul>

    <h4>Time Constants</h4>
    <ul>
        <li>τ<sub>out</sub>: 24-120h — rooms respond slowly to outdoor changes (3-5 days)</li>
        <li>τ<sub>eff</sub>: 4-48h — rooms respond faster to heating changes</li>
        <li>τ<sub>pv</sub>: ~24h for all rooms — consistent solar response time</li>
    </ul>

    <h3>Weighted Average Model Performance</h3>
    <p>Overall weighted R² = <strong>0.698</strong></p>

    <h3>Implications for Optimization</h3>
    <ul>
        <li><strong>Pre-heating timing</strong>: With τ<sub>eff</sub> of 4-48h, rooms need advance notice
            to reach target temperature</li>
        <li><strong>Solar preheating</strong>: Positive g<sub>pv</sub> means rooms benefit from solar gain.
            Schedule comfort periods during/after sunny periods.</li>
        <li><strong>Room variation</strong>: Different rooms respond differently to heating based on g<sub>eff</sub>.</li>
    </ul>

    <figure>
        <img src="fig3.01_thermal_model.png" alt="Thermal Model Analysis">
        <figcaption><strong>Figure 3.1:</strong> Thermal model: heating curve (left),
        actual vs predicted scatter (middle), time series validation (right).</figcaption>
    </figure>

    <h3>Model Term Decomposition</h3>
    <p>The following figure shows how each input term contributes to the predicted room temperature
    over a representative one-week period. Each panel shows the raw input signal (blue, left axis)
    and its contribution to the room temperature prediction (orange, right axis):</p>

    <figure>
        <img src="fig3.01c_model_decomposition.png" alt="Model Term Decomposition">
        <figcaption><strong>Figure 3.1c:</strong> Model term decomposition for a representative week.
        Panel 1: Actual vs predicted room temperature. Panel 2: Outdoor temperature contribution.
        Panel 3: Heating effort contribution. Panel 4: Solar/PV contribution.</figcaption>
    </figure>
    </section>
    